version: '3.8'

services:
  # Neon Local Proxy for Development
  neon-local:
    image: neondatabase/neon_local:latest
    container_name: acquisitions-neon-local
    ports:
      - '5432:5432'
    env_file:
      - .env.development
    volumes:
      # Persist branch metadata per Git branch (optional)
      - ./.neon_local:/tmp/.neon_local
      - ./.git/HEAD:/tmp/.git/HEAD:ro,consistent
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -h localhost -p 5432 -U neon']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - acquisitions-dev

  # Application Service
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    container_name: acquisitions-app-dev
    ports:
      - '3000:3000'
    env_file:
      - .env.development
    volumes:
      # Mount source code for hot reload
      - ./src:/app/src
      - ./package.json:/app/package.json
      - ./drizzle.config.js:/app/drizzle.config.js
      # Mount logs directory for persistence
      - ./logs:/app/logs
      # Mount node_modules as named volume for performance
      - node_modules:/app/node_modules
    depends_on:
      neon-local:
        condition: service_healthy
    networks:
      - acquisitions-dev
    restart: unless-stopped
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'node -e "require(''http'').get(''http://localhost:3000/health'', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Optional: Drizzle Studio for database management
  drizzle-studio:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    container_name: acquisitions-drizzle-studio
    ports:
      - '4983:4983'
    env_file:
      - .env.development
    environment:
      - DATABASE_URL=postgres://neon:npg@neon-local:5432/neondb?sslmode=require
    volumes:
      - ./src:/app/src
      - ./drizzle.config.js:/app/drizzle.config.js
      - ./drizzle:/app/drizzle
    command: ['npm', 'run', 'db:studio']
    depends_on:
      neon-local:
        condition: service_healthy
    networks:
      - acquisitions-dev
    profiles:
      - studio # Use docker-compose --profile studio up to include this service

volumes:
  node_modules:

networks:
  acquisitions-dev:
    driver: bridge
